# 原神抽卡数据处理

一个用于获取、存储、载入、合并、过滤、统计原神抽卡数据的Python库。

![版本](https://img.shields.io/badge/版本-v0.2.0-orange.svg) ![开发环境](https://img.shields.io/badge/开发环境-Python%203.7-blue.svg) ![开源许可证](https://img.shields.io/badge/开源许可证-MIT-green.svg) ![Author](https://img.shields.io/badge/作者-砹小翼-purple.svg)

- 码云 ｜ [中文](https://gitee.com/aixcyi/genshin-gacha-kit)  English
- GitHub ｜ [中文](https://github.com/aixcyi/genshin-gacha-kit)  English



## 目录

1. [关于](#关于)
2. [如何开始](#如何开始)
3. [运行](#运行)
4. [用法](#用法)
   - [GachaPlayer](#GachaPlayer)
   - [GachaWish](#GachaWish)
   - [更多用法](#更多用法)
5. [项目结构](#项目结构)
6. [静态资源](#静态资源)
   - [编号及编号规则](#编号及编号规则)
   - [抽卡数据结构](#抽卡数据结构)
7. [待办](#待办)
8. [数据兼容性](#数据兼容性)



## 关于

大概在2021年三月份，踌躇许久的我着手重写了sunfkny的 [genshin-gacha-export](https://github.com/sunfkny/genshin-gacha-export) ，后来又添加了许多功能，试图打造出一个牛逼的抽卡记录分析软件。围绕抽卡记录可以衍生出极为丰富的功能，但乱花渐欲迷人眼，**方便别人实现符合自己需求的个人程序** 才是立项初衷，于是进行了大量删减优化，逐渐形成一个Python库并在六月份左右开源，以后会将曾经的部分功能以恰当的方式增加到库中，想必这个初衷也会一直秉持下去。

抽卡记录指的是原神的祈愿卡池的抽取历史记录，而这是一个用于管理抽卡记录的Python库，它用类的方式封装实现了以下功能，你只需要实例化区区几个类，就可以很轻易地实现这些功能。

- 获取、保存、载入玩家所有卡池下的抽卡记录，并保存为带颜色标记的xlsx表格；
- 合并不同时期获取的抽卡记录（从而得到完整的抽卡记录）；
- 对单个或多个卡池的抽卡记录进行整合分析（比如多少抽出金）；
- 等等……



## 如何开始

1. 首先需要安装 Python 3.7 或以上版本。已知使用到了内置数据类型 `dict` 键自然排序的新特性，如果 Python 低于这个版本，有可能会发生字典键值排序错乱的问题。
2. 使用命令行 `pip list` 查看本地的库及相应版本号，并确保已经安装好项目依赖的库。如果还没有安装，或者版本低于以下要求，可以使用命令行执行以下语句安装或更新：

```shell
pip install XlsxWriter==1.3.8
pip install requests==2.22.0
```

3. 接下来通过 **开源仓库** 直接下载 **zip压缩包** 后解压到临时目录，并将 **ggacha** 文件夹移动到你的项目的源码根目录中。
4. 之后，你就可以在你的项目中导入这些类来使用了：

```Python
from ggacha import *

# 你的代码……
```

5. 如果需要获取抽卡记录，那么请确保是在Windows平台运行。



## 运行

这个项目是一个Python库，并不能直接运行。不过源码根目录下有一份写好的示例代码 `main.py` ，用于快速展示项目功能，同时提供一个可以一键获取、合并抽卡记录的管理软件给……懒懒的你。（没有图形界面喔）

你可以通过以下命令行运行：

```shell
python ./main.py
```

但首先你需要先 **登录过** 游戏，并进入祈愿面板 **查看过** 历史记录，这段示例代码才有机会执行到底。

开始运行后会自动获取抽卡记录，并保存到当前目录下，然后合并上一次获取的抽卡记录到一个固定命名的JSON汇总文件，最后生成一个xlsx汇总表格。

为什么有合并这一说呢？那是因为原神里最多能看到最近六个月的历史记录，再往前就没有了，所以某一次获取到的记录可能并不完整，因而需要结合以前获取的记录，合并出一份完整的。

如果这是第一次获取，它同样会生成JSON汇总文件和xlsx汇总表格，只不过前者和后两者记录的数据都是一样的而已。

每一次获取的记录都会保存到新的文件中，上一次获取的记录仅作读取合并用，不会再被更改，这样当完整版抽卡记录丢失后，仍然可以通过这些不完整的片段合并得到。其命名格式是 `raw_{UID}_{time}.json` ，其中 `UID` 是玩家id，`time` 是这一次获取的开始时间。

汇总的JSON文件的命名格式是 `ggr_{UID}.json` ，而汇总表格的命名格式是 `ggr_{UID}.xlsx` 。

_UID对于数据分析而言并无作用，为安全起见，请不要泄漏给任何人。_



## 用法

### GachaPlayer

这是个可以存储多个卡池的抽卡记录的类，主要功能是获取、合并、存储、载入一个玩家（所有卡池）的抽卡记录。

获取并保存玩家（所有卡池）的抽卡记录：

```Python
from datetime import datetime
from ggacha import GachaPlayer

snapshot = GachaPlayer()
snapshot.init()
snapshot.collect()
snapshot.dump(
    file="./records_%s.json" % datetime.now().strftime("%Y%m%d%H%M%S"),
    save_uid=True,
)
```

合并（所有卡池的）抽卡记录并保存：

```Python
master = GachaPlayer(file="./records_full.json")
master += snapshot
master.dump(
    file="./records_full.json",
    save_uid=True,
)
```

直接遍历所有卡池（因为 `wishes` 实际上就只是个列表而已）：

```Python
from ggacha import GachaPlayer

infos = GachaPlayer()
for wish in infos.wishes:
    print(wish.wish_name)  # wish_name不为空字符串表明数据已经载入成功或获取完毕。
    print(wish.records)  # 当前卡池的所有抽卡记录。
```

但如果你的操作会改变一个卡池中的某一部分数据，则强烈建议用索引的方式访问，避免日后因浅拷贝而出现问题：

```Python
for i in range(len(master.wishes)):

    # 对抽卡记录进行排序：
    master.wishes[i].sort()

    # 修改卡池名称：
    if master.wishes[i].wish_type == '200':
    	master.wishes[i].wish_name = '常驻祈愿卡池'
        break
```

需要注意的是：获取抽卡记录的方法是 `collect_one()` ，这个函数只能在 Windows 平台上使用，因为项目是通过读取原神日志文件的方式得到授权（从而不必提供账号密码），从而获取抽卡记录的，而目前只知道日志文件在前述平台上的位置。同样的，依赖这个方法的 `collect()` 方法也是如此。



### GachaWish

这是存储单个卡池的抽卡记录的类，主要功能有抽卡记录合并、排序、聚合分析等。

如果你不打算 `GachaWish` 局限于单个玩家，那么其实可以用它来实现对某一个卡池多个玩家的抽卡记录的大数据分析。特地强调这个是因为目前不太建议这么做，这个项目毕竟是针对个人开发的，在数据量大的情况下，运行效率可能低得令人发指（但并没有试过，つ﹏⊂）。

如果需要获取／保存／载入抽卡记录，请浏览 [GachaPlayer](#GachaPlayer) ，针对单个卡池的保存功能正在规划。



### 更多用法

Python语法允许我们在代码中写文档，这叫做 **文档字符串 (docstring)**，而项目详细的用法，参数、返回值说明等都写在了文档字符串中，并遵循 **reStructuredText** 语法，最重要的是这会优先于 README 更新，因此请多多参阅并以代码为准。

如果有任何疑问或问题，都可以提交 [issue](https://github.com/aixcyi/genshin-gacha-kit/issues) 寻求解答或反馈；若有兴趣，不妨提交 [Pull Request](https://github.com/aixcyi/genshin-gacha-kit/pulls) 帮助我们更好地打造这个项目。

另外，如果你使用 PyCharm 打开本项目，那么可以按下 `Ctrl` + `Alt` + `S` 打开设置面板，将

```
工具 > Python 集成工具 > 文档字符串 > 文档字符串格式
```

设置为 `reStructuredText` ，然后你将看到字符串被渲染了，并且将鼠标移动到代码上还会出现相应的提示哦。



## 项目结构

- `ggacha` 当前项目
  - `GachaPlayer` 所有卡池的抽卡记录类。
  - `GachaWish` 单个卡池的抽卡记录类。
  - `throwable` 异常包。提供本项目抛出的错误和异常。
  - `common` 公共包。提供通用的、不受游戏版本更新影响的函数。大部分为项目内部开发提供。
  - `ext` 扩展包。提供一些基于核心代码的扩展函数。
  - `res` 常量包。提供可以被代码直接调用的静态资源。
- `resources` 静态数据文件夹。
  - `items.json`
  - `wishes.json`
- `main.py` 对项目的简单应用。



## 静态资源

项目源码中附带了关于部分角色武器信息和祈愿卡池历史信息，这些信息存放在静态数据文件夹 `resources` 中。为了让包体更加便携，这部分数据也以Python代码的形式存放在了 `ggacha.res` 中，需要的时候直接导入相关常量即可，但前者将会优先于后者更新。



### items.json

该文件记录了部分祈愿物品的信息，包括角色和武器。

为方便数据查找和跨语言展示，项目对物品进行了编号。编号规则如下：

- 所有编号均使用十六进制整数字符串表示，使用字符串形式记录在文件中。
- 目前编号只有四位数。以下所说的第几位均以字符串的 **从右到左** 表示。
- 对于角色
  - 第四位是所属国家：`1`蒙德，`2`璃月，`3`稻妻，`7`至冬。
  - 第三位是元素属性：`1`火系，`2`水系，`3`冰系，`4`雷系，`5`草系，`6`风系，`7`岩系。
  - 第二位是武器类型：`1`单手剑，`2`双手剑，`3`长柄武器，`4`法器，`5`弓。
  - 第一位是组合值，其中
    - 组合值对应二进制的第四位为`1`表示是五星角色，为`0`表示是四星角色。
    - 组合值对应二进制的低3位是序号，用于在所属国家、元素属性、武器类型、星级均相同时区分，序号取值范围是`0`到`7`。
  - 假定旅行者不属于角色，不分配编号。
  - 举例1：蒙德(`1`)风系(`6`)、使用弓箭(`5`)的五星角色温迪，其编号为`1658`，其中的`8`对应二进制`1000`。
  - 举例2：璃月(`2`)火系(`1`)、使用长枪(`3`)的四星角色香菱，其编号为`2130`，其中的`0`对应二进制`0000`。
- 对于武器
  - 第四位是武器类型：`1`单手剑，`2`双手剑，`3`长柄武器，`4`法器，`5`弓。
  - 第三位是武器星级：`A`五星，`B`四星，`C`三星。
  - 第二位是副属性：`1`攻击力，`2`防御力，`3`生命值，`4`元素充能效率，`5`元素精通，`6`物理伤害加成，`7`暴击率，`8`暴击伤害。
  - 第一位是序号，用于在星级、类型、副属性均相同时区分，序号取值范围是`0`到`15`。
- 编号顺序参照游戏图鉴中的排序。



### wishes.json

该文件记录了部分祈愿卡池的历史信息（目前只有每一期概率提升的哪些角色）。

其中记录卡池开启时间的字段为 **time** ，但实际上卡池在版本更新完毕即开启，而版本更新完毕的时间并不能确定，因此项目使用了 [第三方抽卡数据集](https://github.com/OneBST/GI_gacha_dataset) 中的时间加以修正。而如果时间被修正过，则原本的预计的时间就会挪到另一字段 **plan** 中。



### 抽卡记录结构

原始的抽卡记录的数据结构：

```json
{
    "uid": "玩家id",
    "gacha_type": "200",
    "item_id": "",
    "count": "1",
    "time": "2021-01-21 18:08:54",
    "name": "芭芭拉",
    "lang": "zh-cn",
    "item_type": "角色",
    "rank_type": "4",
    "id": "19位阿拉伯数字，抽卡记录的ID"
}
```

项目存取的抽卡记录的数据结构：

```json
{
    "time": "2021-01-21 18:08:54",
    "name": "芭芭拉",
    "item_type": "角色",
    "rank_type": "4",
    "id": "19位阿拉伯数字，抽卡记录的ID"
}
```

其中 `time` 和 `id` 字段是必须的，因为排序、合并等功能都依赖这两个字段。



## 待办

- [ ] ~~为 `README.md` 添加英语版本（Python docstring 实在力不从心）。~~
- [x] 为 `GachaWish` 添加历史信息查询和保底计算。
- [x] 在README中添加对静态资源添的说明，比如祈愿卡池历史信息中的 `plan` 字段。
- [ ] ~~添加发起 Pull Request 的简易教程。~~
- [ ] 通过单独的函数允许用户在必要的时候去除或掩盖重要数据。
- [x] 将日志读取方法内的日志路径独立为参数并公开，方便其他平台探索。



## 数据兼容性
项目还没有正式发布，所以导出的数据格式没有作向后兼容。

你可以比对两版本间的格式差异，然后正常拉取抽卡记录，之后，用拉取到的部分按日期时间覆盖掉原先的记录，或者将多出的字段删掉。

因为设计之初，RID的编码空间就比id大，所以可以将键名"RID"替换为"id"。二者可以互相作为一条抽卡记录的唯一标识符。


### v0.2
1. 全面弃用杂凑。重要数据直接原样导出，并通过单独的函数让用户在必要的时候去除或掩盖。

这个版本开始启用的格式：
```json
{
    "time": "2021-01-21 18:08:54",
    "name": "芭芭拉",
    "item_type": "角色",
    "rank_type": "4",
    "id": "19位阿拉伯数字，抽卡记录的ID"
}
```

上一个版本的格式：
```json
{
    "time": "2021-01-21 18:08:54",
    "name": "芭芭拉",
    "item_type": "角色",
    "rank_type": "4",
    "RID": "经过杂凑的32个字符的抽卡记录ID"
}
```


### v0.1
1. 抽卡记录的存储格式从原始结构变成项目定义的结构。

这个版本开始启用的格式：
```json
{
    "time": "2021-01-21 18:08:54",
    "name": "芭芭拉",
    "item_type": "角色",
    "rank_type": "4",
    "RID": "经过杂凑的32个字符的抽卡记录ID"
}
```

上一个版本的格式：
```json
{
    "uid": "玩家id",
    "gacha_type": "200",
    "item_id": "",
    "count": "1",
    "time": "2021-01-21 18:08:54",
    "name": "芭芭拉",
    "lang": "zh-cn",
    "item_type": "角色",
    "rank_type": "4",
    "id": "19位阿拉伯数字，抽卡记录的ID"
}
```
